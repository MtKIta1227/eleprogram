<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ラミセル計算ツール</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:#f7f7f7;margin:0;padding:16px;}
  h1{font-size:1.22rem;margin:0 0 10px 0;padding-top:36px;}
  .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
  label{display:block;font-size:0.85rem;margin-top:12px;}
  input{width:100%;padding:10px;font-size:1rem;border-radius:8px;border:1px solid #ccc;}
  .btnRow{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;}
  button{flex:1;min-width:140px;padding:12px 14px;font-size:1.02rem;border-radius:10px;border:none;background:#1976d2;color:#fff;}
  button.done{background:#2e7d32;}
  button.ghost{background:#e0e0e0;color:#111;}
  button.danger{background:#d32f2f;}
  button.warn{background:#ef6c00;}
  button.small{padding:10px 12px;font-size:0.95rem;min-width:150px;}
  .result{font-size:0.95rem;margin-top:6px;line-height:1.25;}
  .value{font-weight:650;}
  .muted{color:#666;font-weight:550;}
  small{color:#666;display:block;line-height:1.35;}

  .pill{position:fixed;top:12px;left:12px;z-index:9999;background:#fff;border:1px solid #ddd;border-radius:999px;padding:8px 12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);font-size:0.88rem;font-weight:650;}
  .pill.wait{color:#666;}
  .pill.ready{color:#1565c0;border-color:#b5d4ff;}
  .pill.done{color:#2e7d32;border-color:#b7e1c0;}
  .pill.err{color:#c62828;border-color:#f1b4b4;}
  .pill.info{color:#2e3a59;border-color:#c8d0e0;}

  .notice{background:#fff3cd;border:1px solid #ffe69c;color:#664d03;padding:10px 12px;border-radius:10px;margin-bottom:12px;font-size:0.9rem;line-height:1.35;}
  details{border-top:1px dashed #ddd;margin-top:12px;padding-top:12px;}
  summary{cursor:pointer;font-weight:650;color:#333;list-style:none;}
  summary::-webkit-details-marker{display:none;}
  .badge{display:inline-block;background:#f1f3f5;border:1px solid #e1e5ea;border-radius:999px;padding:2px 10px;font-weight:650;font-size:0.82rem;color:#333;}
  .formula{margin-top:10px;font-size:0.95rem;line-height:1.55;}
  .formula h3{font-size:1rem;margin:12px 0 6px 0;}
  .formula ul{margin:6px 0 0 18px;padding:0;}
  .formula li{margin:6px 0;}
  .eqline{margin:2px 0 0 0;color:#111;}
  .sep{margin:12px 0;border-top:1px solid #eee;}

  .emph{font-weight:800;}
  .hl{background:#eef6ff;border:1px solid #cfe6ff;border-radius:10px;padding:10px 12px;margin-top:10px;}

  /* Results table */
  .tableWrap{overflow:auto;border:1px solid #eee;border-radius:12px;}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:1120px;background:#fff;}
  thead th{
    position:sticky;top:0;background:#fafafa;
    font-size:0.85rem;text-align:left;padding:10px;border-bottom:1px solid #e9ecef;
    white-space:nowrap;
  }
  tbody td{
    font-size:0.9rem;padding:10px;border-bottom:1px solid #f1f3f5;white-space:nowrap;
    vertical-align:middle;
  }
  tbody tr:last-child td{border-bottom:none;}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #e1e5ea;background:#f6f8fa;font-weight:650;font-size:0.78rem;}
  .right{text-align:right;}
  .center{text-align:center;}
  .chk{transform:scale(1.15);}
  .actionsRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
  textarea{width:100%;min-height:110px;resize:vertical;border-radius:10px;border:1px solid #ccc;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:0.9rem;}
</style>
</head>
<body>

<div id="pill" class="pill wait">⏳ 未計算</div>

<noscript>
  <div class="notice">JavaScript が無効のため計算できません。ブラウザで開いてください。</div>
</noscript>

<h1>ラミセル計算ツール</h1>

<div class="card">
  <div class="notice" id="jsNotice" style="display:none;">✅ JavaScript 動作中（この表示が出ていれば計算できます）</div>

  <label>正極重量（集電体込み） (g)</label>
  <input id="mtotal" inputmode="decimal" placeholder="例：0.2949" />

  <label>集電体の重量 (g)</label>
  <input id="mfoil" inputmode="decimal" placeholder="例：0.105" />

  <label>スラリー中の活物質割合（例：0.90）</label>
  <input id="w_active" inputmode="decimal" value="0.9" />

  <label>活物質中の硫黄分率（例：0.64）</label>
  <input id="ws" inputmode="decimal" value="0.64" />

  <label>有効面積：縦 (cm)</label>
  <input id="len_y" inputmode="decimal" value="2.5" />

  <label>有効面積：横 (cm)</label>
  <input id="len_x" inputmode="decimal" value="2.3" />

  <label>E/S 設定値（µL per mg-S）</label>
  <input id="es" inputmode="decimal" value="3" />

  <label>C-rate（例：0.1）</label>
  <input id="crate" inputmode="decimal" value="0.1" />

  <div class="btnRow">
    <button id="calcBtn" type="button">計算する</button>
    <button id="resetBtn" class="ghost" type="button">リセット</button>
  </div>

  <details>
    <summary>計算式（タップで詳細表示） <span class="badge">有効数字 4 桁（※E/Sは2桁）</span></summary>
    <div class="formula">
      <h3>単位の前提</h3>
      <ul>
        <li>質量の入力：g</li>
        <li><span class="emph">硫黄量</span>：mg（表示・計算）</li>
        <li>両面塗工を仮定：有効面積 = 縦 × 横 × 2（cm²）</li>
        <li>硫黄の理論比容量：1672 mAh g⁻¹ = 1.672 mAh mg⁻¹</li>
      </ul>

      <div class="sep"></div>

      <h3>1) 質量から硫黄量まで</h3>
      <ul>
        <li>スラリー重量（g）<div class="eqline">= 正極重量（集電体込み）（g） − 集電体の重量（g）</div></li>
        <li>活物質量（g）<div class="eqline">= スラリー重量（g） × 活物質割合（−）</div></li>
        <li><span class="emph">硫黄量（mg）</span><div class="eqline">= 活物質量（g） × 硫黄分率（−） × 1000</div></li>
      </ul>

      <div class="sep"></div>

      <h3>2) 面積</h3>
      <ul>
        <li>有効面積（cm², 両面）<div class="eqline">= 縦（cm） × 横（cm） × 2</div></li>
      </ul>

      <div class="sep"></div>

      <h3>3) 容量・電流・注液量</h3>
      <ul>
        <li><span class="emph">理論容量（mAh）</span><div class="eqline">= 硫黄量（mg） × 1.672（mAh per mg-S）</div></li>
        <li><span class="emph">設定電流（mA）</span><div class="eqline">= C-rate（−） × 理論容量（mAh）</div></li>
        <li><span class="emph">注液量（µL）</span><div class="eqline">= E/S（µL per mg-S） × 硫黄量（mg）</div></li>
      </ul>

      <div class="sep"></div>

      <h3>4) 面積規格化</h3>
      <ul>
        <li><span class="emph">S loading（mg cm⁻²）</span><div class="eqline">= 硫黄量（mg） ÷ 有効面積（cm²）</div></li>
        <li>面積容量（mAh cm⁻²）<div class="eqline">= 理論容量（mAh） ÷ 有効面積（cm²）</div></li>
        <li>面積電流（mA cm⁻²）<div class="eqline">= 設定電流（mA） ÷ 有効面積（cm²）</div></li>
      </ul>

      <div class="sep"></div>

      <small>
        ※補足：硫黄比容量は 1672 mAh g⁻¹ なので、硫黄量を g で扱うなら「理論容量 = 1672 × 硫黄量（g）」と同値です。
      </small>
    </div>
  </details>
</div>

<div class="card">
  <div class="result"><span class="muted">スラリー重量</span>: <span class="value" id="mslurry">-</span> g</div>
  <div class="result"><span class="muted">活物質量</span>: <span class="value" id="mactive">-</span> g</div>

  <div class="hl">
    <div class="result"><span class="muted">硫黄量</span>: <span class="value emph" id="ms">-</span> mg</div>
    <div class="result"><span class="muted">S loading（両面）</span>: <span class="value emph" id="ms_a">-</span> mg cm⁻²</div>
    <div class="result"><span class="muted">理論容量</span>: <span class="value emph" id="qth">-</span> mAh</div>
    <div class="result"><span class="muted" id="ilabel">設定電流</span>: <span class="value emph" id="current">-</span> mA</div>
    <div class="result"><span class="muted" id="vlabel">注液量（E/S=3）</span>: <span class="value emph" id="vtarget">-</span> µL</div>
  </div>

  <div class="result"><span class="muted">有効面積（両面）</span>: <span class="value" id="area">-</span> cm²</div>
  <div class="result"><span class="muted">面積容量</span>: <span class="value" id="qth_a">-</span> mAh cm⁻²</div>
  <div class="result"><span class="muted">面積電流</span>: <span class="value" id="current_a">-</span> mA cm⁻²</div>

  <small style="margin-top:10px;">入力は全角/半角どちらでもOK。小数点は「.」「．」「。」どれでもOK。</small>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
    <div style="font-weight:800;">計算結果一覧表</div>
    <div class="actionsRow">
      <button id="copyAllBtn" class="small" type="button">Excel用にコピー</button>
      <button id="deleteSelectedBtn" class="warn small" type="button">選択行を削除</button>
      <button id="clearHistoryBtn" class="danger small" type="button">一覧をクリア</button>
    </div>
  </div>
  <small style="margin-top:8px;">「計算する」を押すたびに1行追加されます（端末内に保存）。チェックして「選択行を削除」もできます。</small>
  <div style="height:10px;"></div>
  <div class="tableWrap">
    <table id="historyTable">
      <thead>
        <tr>
          <th class="center"><input id="checkAll" type="checkbox" class="chk" /></th>
          <th>時刻</th>
          <th class="right">正極重量（集電体込み） (g)</th>
          <th class="right">E/S</th>
          <th class="right">C-rate</th>
          <th class="right">硫黄量 (mg)</th>
          <th class="right">S loading (mg/cm²)</th>
          <th class="right">理論容量 (mAh)</th>
          <th class="right">設定電流 (mA)</th>
          <th class="right">注液量 (µL)</th>
          <th class="right">有効面積 (cm²)</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <tr><td colspan="11" style="color:#666;">まだ履歴はありません。</td></tr>
      </tbody>
    </table>
  </div>

  <details style="margin-top:12px;">
    <summary>コピー内容を表示（うまくコピーできないとき用） <span class="badge">TSV</span></summary>
    <div style="height:10px;"></div>
    <textarea id="clipboardText" readonly placeholder="ここにExcel貼り付け用の文字列が出ます"></textarea>
    <small style="margin-top:8px;">この内容を全選択→コピー→Excelに貼り付けでもOK。</small>
  </details>
</div>

<script>
function toNumber(val){
  if (val === null || val === undefined) return 0;
  let s = String(val).trim();
  if (!s) return 0;
  s = s.replace(/[,，\u00A0\s]/g, "");
  s = s.replace(/[。．]/g, ".");
  s = s.replace(/[−ー―]/g, "-");
  s = s.replace(/[０-９．－]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function prettySig(n, digits){
  if (!Number.isFinite(n)) return "-";
  if (n === 0) return "0";
  let s = n.toPrecision(digits);
  if (s.includes("e") || s.includes("E")) return s;
  if (s.includes(".")) s = s.replace(/0+$/,"").replace(/\.$/,"");
  return s;
}
function sig(n, digits=4){ return prettySig(n, digits); }
function sigES(n){ return prettySig(n, 2); } // E/Sだけ2桁

const el = id => document.getElementById(id);
const inputs = ["mtotal","mfoil","w_active","ws","len_y","len_x","es","crate"].map(el);
const pill = el("pill");
const calcBtn = el("calcBtn");
const jsNotice = el("jsNotice");
const vlabel = el("vlabel");
const ilabel = el("ilabel");
const historyBody = el("historyBody");
const checkAll = el("checkAll");
const clipboardText = el("clipboardText");

const STORAGE_KEY = "matsui_special_history_v5";

function updateVLabel(){
  const ES = toNumber(el("es").value);
  vlabel.textContent = (ES > 0) ? `注液量（E/S=${sigES(ES)}）` : "注液量（E/S=未設定）";
}
function updateILabel(){
  const Cr = toNumber(el("crate").value);
  ilabel.textContent = (Cr > 0) ? `設定電流（C-rate=${sig(Cr)}）` : "設定電流（C-rate=未設定）";
}
function setPill(state, text){
  pill.className = "pill " + state;
  pill.textContent = text;
  if (state === "done") calcBtn.classList.add("done");
  else calcBtn.classList.remove("done");
}
function markDirty(){ setPill("wait","⏳ 未計算"); }
function setAllDash(){
  ["mslurry","mactive","ms","area","ms_a","qth","qth_a","current","current_a","vtarget"].forEach(id => el(id).textContent = "-");
}

/* 履歴 */
function loadHistory(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}
function saveHistory(arr){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch(e){}
}
function renderHistory(arr){
  historyBody.innerHTML = "";
  clipboardText.value = "";
  if (!arr.length){
    historyBody.innerHTML = '<tr><td colspan="11" style="color:#666;">まだ履歴はありません。</td></tr>';
    checkAll.checked = false;
    return;
  }
  for (let idx=0; idx<arr.length; idx++){
    const row = arr[idx];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center"><input type="checkbox" class="chk rowChk" data-idx="${idx}" /></td>
      <td><span class="tag">${row.t}</span></td>
      <td class="right"><b>${row.mtotal}</b></td>
      <td class="right">${row.es}</td>
      <td class="right">${row.cr}</td>
      <td class="right"><b>${row.ms}</b></td>
      <td class="right"><b>${row.sl}</b></td>
      <td class="right"><b>${row.qth}</b></td>
      <td class="right"><b>${row.i}</b></td>
      <td class="right">${row.v}</td>
      <td class="right">${row.a}</td>
    `;
    historyBody.appendChild(tr);
  }
  checkAll.checked = false;
}
function addHistory(entry){
  const arr = loadHistory();
  arr.unshift(entry);
  const trimmed = arr.slice(0, 60);
  saveHistory(trimmed);
  renderHistory(trimmed);
}

function getSelectedIndices(){
  const chks = Array.from(document.querySelectorAll(".rowChk"));
  const idxs = chks.filter(c => c.checked).map(c => Number(c.dataset.idx));
  idxs.sort((a,b)=>a-b);
  return idxs;
}

document.getElementById("clearHistoryBtn").addEventListener("click", () => {
  saveHistory([]);
  renderHistory([]);
  setPill("ready","✅ 入力して計算");
});

checkAll.addEventListener("change", () => {
  const chks = Array.from(document.querySelectorAll(".rowChk"));
  chks.forEach(c => c.checked = checkAll.checked);
});

document.getElementById("deleteSelectedBtn").addEventListener("click", () => {
  const idxs = getSelectedIndices();
  if (!idxs.length){
    setPill("info","ℹ 選択なし");
    return;
  }
  const arr = loadHistory();
  for (let i = idxs.length - 1; i >= 0; i--){
    arr.splice(idxs[i], 1);
  }
  saveHistory(arr);
  renderHistory(arr);
  setPill("done",`✔ ${idxs.length}行削除`);
});

function historyToTSV(arr){
  const header = ["時刻","正極重量（集電体込み） (g)","E/S","C-rate","硫黄量 (mg)","S loading (mg/cm²)","理論容量 (mAh)","設定電流 (mA)","注液量 (µL)","有効面積 (cm²)"];
  const lines = [header.join("\t")];
  for (const r of arr){
    lines.push([r.t, r.mtotal, r.es, r.cr, r.ms, r.sl, r.qth, r.i, r.v, r.a].join("\t"));
  }
  return lines.join("\n");
}

async function copyTextToClipboard(text){
  try{
    if (navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      return true;
    }
  }catch(e){}
  try{
    const ta = clipboardText;
    ta.value = text;
    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand("copy");
    return ok;
  }catch(e){
    return false;
  }
}

document.getElementById("copyAllBtn").addEventListener("click", async () => {
  const arr = loadHistory();
  if (!arr.length){
    setPill("info","ℹ 履歴なし");
    return;
  }
  const tsv = historyToTSV(arr);
  clipboardText.value = tsv;
  const ok = await copyTextToClipboard(tsv);
  setPill(ok ? "done" : "info", ok ? "✔ コピーしました" : "ℹ コピーできない場合は下の欄から手動コピー");
});

/* 初期化 */
jsNotice.style.display = "block";
pill.className = "pill ready";
pill.textContent = "✅ 入力して計算";
updateVLabel();
updateILabel();
renderHistory(loadHistory());

inputs.forEach(i => i.addEventListener("input", () => {
  markDirty();
  if (i.id === "es") updateVLabel();
  if (i.id === "crate") updateILabel();
}));
inputs.forEach(i => i.addEventListener("change", () => {
  markDirty();
  if (i.id === "es") updateVLabel();
  if (i.id === "crate") updateILabel();
}));

document.getElementById("resetBtn").addEventListener("click", () => {
  inputs.forEach(i => {
    if (i.id === "w_active") i.value = "0.9";
    else if (i.id === "ws") i.value = "0.64";
    else if (i.id === "crate") i.value = "0.1";
    else if (i.id === "len_y") i.value = "2.5";
    else if (i.id === "len_x") i.value = "2.3";
    else if (i.id === "es") i.value = "3";
    else i.value = "";
  });
  updateVLabel();
  updateILabel();
  setAllDash();
  setPill("ready","✅ 入力して計算");
});

calcBtn.addEventListener("click", () => {
  try{
    const mtotal = toNumber(el("mtotal").value);
    const mfoil  = toNumber(el("mfoil").value);
    const fActive = toNumber(el("w_active").value);
    const wS = toNumber(el("ws").value);
    const Ly = toNumber(el("len_y").value);
    const Lx = toNumber(el("len_x").value);
    const ES = toNumber(el("es").value);
    const Cr = toNumber(el("crate").value);

    updateVLabel();
    updateILabel();

    if (!(mtotal > 0) || !(mfoil >= 0) || !(fActive > 0) || !(wS > 0) || !(Lx > 0) || !(Ly > 0)){
      setPill("err","⚠ 入力不足");
      return;
    }
    if (mfoil > mtotal){
      setPill("err","⚠ 集電体が重すぎ");
      return;
    }

    const slurry_g = mtotal - mfoil;       // スラリー重量（g）
    const active_g = slurry_g * fActive;   // g
    const mS_mg = active_g * wS * 1000;    // mg
    const A = 2 * Lx * Ly;                 // cm^2（両面）

    const Qth = 1.672 * mS_mg;             // mAh
    const I = Cr * Qth;                    // mA
    const V = (ES > 0) ? ES * mS_mg : NaN; // µL

    el("mslurry").textContent = sig(slurry_g);
    el("mactive").textContent = sig(active_g);
    el("ms").textContent = sig(mS_mg);
    el("area").textContent = sig(A);

    el("qth").textContent = sig(Qth);
    el("current").textContent = sig(I);

    el("ms_a").textContent = sig(mS_mg / A);
    el("qth_a").textContent = sig(Qth / A);
    el("current_a").textContent = sig(I / A);

    el("vtarget").textContent = Number.isFinite(V) ? sig(V) : "-";

    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    setPill("done",`✔ 計算完了 ${hh}:${mm}`);

    addHistory({
      t: `${hh}:${mm}`,
      mtotal: sig(mtotal),
      es: (ES > 0) ? sigES(ES) : "-",
      cr: (Cr > 0) ? sig(Cr) : "-",
      ms: sig(mS_mg),
      sl: sig(mS_mg / A),
      qth: sig(Qth),
      i: sig(I),
      v: Number.isFinite(V) ? sig(V) : "-",
      a: sig(A),
    });

  }catch(e){
    setPill("err","⚠ エラー");
  }
});
</script>

</body>
</html>
